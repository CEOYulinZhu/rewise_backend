# äºŒæ‰‹å¹³å°æœç´¢Agent

## æ¦‚è¿°

äºŒæ‰‹å¹³å°æœç´¢Agentæ˜¯ä¸€ä¸ªä¸“ä¸šçš„äºŒæ‰‹å•†å“æœç´¢æ™ºèƒ½ä½“ï¼Œä½¿ç”¨è“å¿ƒå¤§æ¨¡å‹çš„Function CallingåŠŸèƒ½ï¼ŒåŸºäºç‰©å“åˆ†æç»“æœæ™ºèƒ½æå–æœç´¢å…³é”®è¯ï¼Œå¹¶åœ¨é—²é±¼ã€çˆ±å›æ”¶ç­‰å¹³å°æœç´¢ç›¸å…³å•†å“ä¿¡æ¯ï¼Œæä¾›å¸‚åœºä»·æ ¼å‚è€ƒå’Œå›æ”¶ä»·å€¼è¯„ä¼°ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ§  æ™ºèƒ½å…³é”®è¯æå–
- **Function Calling**ï¼šä½¿ç”¨è“å¿ƒå¤§æ¨¡å‹çš„Function CallingæŠ€æœ¯
- **å¤šç»´åº¦ç†è§£**ï¼šæ·±åº¦ç†è§£ç‰©å“å“ç‰Œã€å‹å·ã€çŠ¶æ€ã€ç±»åˆ«ç­‰ç‰¹å¾
- **å¹³å°ä¼˜åŒ–**ï¼šé’ˆå¯¹ä¸åŒå¹³å°ç‰¹ç‚¹ç”Ÿæˆä¼˜åŒ–å…³é”®è¯
- **æœç´¢æ„å›¾**ï¼šè‡ªåŠ¨ç”Ÿæˆæœç´¢æ„å›¾å’Œå¹³å°ç­–ç•¥

### ğŸ›’ å¤šå¹³å°æœç´¢
- **é—²é±¼å¹³å°**ï¼šä¸ªäººé—²ç½®äº¤æ˜“å¹³å°ï¼Œå…³æ³¨æˆè‰²ã€ä¸ªäººè½¬è®©
- **çˆ±å›æ”¶å¹³å°**ï¼šä¸“ä¸šå›æ”¶ä¼°ä»·å¹³å°ï¼Œå…³æ³¨å“ç‰Œã€å›æ”¶ä»·å€¼
- **å¹¶è¡Œæœç´¢**ï¼šåŒæ—¶æœç´¢å¤šä¸ªå¹³å°ï¼Œæé«˜æ•ˆç‡
- **ç»Ÿä¸€ç»“æœ**ï¼šæ ‡å‡†åŒ–çš„æœç´¢ç»“æœæ ¼å¼

### ğŸ’° ä»·æ ¼åˆ†æ
- **å¸‚åœºè¡Œæƒ…**ï¼šè·å–åŒç±»å•†å“çš„å¸‚åœºä»·æ ¼èŒƒå›´
- **å›æ”¶ä»·å€¼**ï¼šäº†è§£ä¸“ä¸šå›æ”¶å¹³å°çš„ä¼°ä»·
- **ä»·æ ¼ç»Ÿè®¡**ï¼šæä¾›æœ€ä½ã€æœ€é«˜ã€å¹³å‡ä»·æ ¼ç­‰ç»Ÿè®¡ä¿¡æ¯
- **è¶‹åŠ¿åˆ†æ**ï¼šå¸®åŠ©ç”¨æˆ·äº†è§£å•†å“ä¿å€¼æƒ…å†µ

### ğŸ”„ æ™ºèƒ½å¤‡ç”¨æœºåˆ¶
- **åŒé‡ä¿éšœ**ï¼šFunction Calling + è§„åˆ™å¤‡ç”¨
- **åˆ†ç±»æ˜ å°„**ï¼šé¢„è®¾å¤šä¸ªç‰©å“ç±»åˆ«çš„å…³é”®è¯æ˜ å°„
- **å“ç‰Œè¯†åˆ«**ï¼šæ™ºèƒ½è¯†åˆ«å“ç‰Œå¹¶ä¼˜åŒ–æœç´¢ç­–ç•¥
- **çŠ¶æ€æ˜ å°„**ï¼šæ ¹æ®ç‰©å“çŠ¶æ€è°ƒæ•´æœç´¢å…³é”®è¯

## æ¶æ„ä¼˜åŒ–

### ğŸ“ˆ æ€§èƒ½æå‡
- **å¹¶è¡Œæœç´¢**ï¼šåŒæ—¶æœç´¢å¤šä¸ªå¹³å°ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
- **ä¸“ä¸šæå–**ï¼šä¸“æ³¨äºå…³é”®è¯æå–å’Œå•†å“æœç´¢
- **ç¼“å­˜å‹å¥½**ï¼šåˆ†æç»“æœå¯è¢«å¤šä¸ªæ¨¡å—å¤ç”¨
- **èµ„æºç®¡ç†**ï¼šè‡ªåŠ¨ç®¡ç†HTTPè¿æ¥å’ŒAPIè°ƒç”¨

### ğŸ”§ ç»´æŠ¤æ€§æå‡
- **å•ä¸€èŒè´£**ï¼šä¸“æ³¨æ ¸å¿ƒæœç´¢åŠŸèƒ½
- **æ¨¡å—è§£è€¦**ï¼šä¸ä¾èµ–å›¾ç‰‡/æ–‡å­—åˆ†ææœåŠ¡
- **æ ‡å‡†æ¥å£**ï¼šç»Ÿä¸€çš„åˆ†æç»“æœè¾“å…¥æ ¼å¼
- **æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„äºŒæ‰‹å¹³å°

## è¾“å…¥è¾“å‡ºè§„èŒƒ

### è¾“å…¥æ ¼å¼

```python
analysis_result = {
    "category": "ç”µå­äº§å“",           # å¿…éœ€ï¼šç‰©å“ç±»åˆ«
    "sub_category": "æ‰‹æœº",          # å¯é€‰ï¼šå­ç±»åˆ«
    "brand": "è‹¹æœ",                 # å¯é€‰ï¼šå“ç‰Œä¿¡æ¯
    "model": "iPhone 13",           # å¯é€‰ï¼šå‹å·ä¿¡æ¯
    "condition": "95æ–°",            # å¿…éœ€ï¼šç‰©å“çŠ¶æ€
    "description": "è‹¹æœiPhone13...", # å¿…éœ€ï¼šè¯¦ç»†æè¿°
    "color": "é»‘è‰²",                # å¯é€‰ï¼šé¢œè‰²
    "storage": "128GB",             # å¯é€‰ï¼šå­˜å‚¨å®¹é‡
    "keywords": ["iPhone", "æ‰‹æœº"],  # å¯é€‰ï¼šå·²æœ‰å…³é”®è¯
    "special_features": "Face ID"   # å¯é€‰ï¼šç‰¹æ®ŠåŠŸèƒ½
}
```

### è¾“å‡ºæ ¼å¼

```python
{
    "success": True,
    "source": "analysis_result",
    "analysis_result": {...},       # åŸå§‹åˆ†æç»“æœ
    "result": {
        "success": True,
        "total_products": 25,
        "products": [
            {
                "platform": "é—²é±¼",
                "title": "è‹¹æœiPhone13 128G é»‘è‰²",
                "seller": "ç”¨æˆ·123",
                "price": 4500,
                "image_url": "https://...",
                "location": "ä¸Šæµ·",
                "platform_type": "C2C"
            },
            {
                "platform": "çˆ±å›æ”¶",
                "title": "iPhone 13 128GB",
                "seller": "çˆ±å›æ”¶å®˜æ–¹",
                "price": 4200,
                "image_url": "https://...",
                "location": "å…¨å›½",
                "platform_type": "B2C"
            }
        ],
        "platform_stats": {
            "xianyu": {
                "success": True,
                "product_count": 15,
                "price_stats": {
                    "min_price": 4000,
                    "max_price": 5200,
                    "average_price": 4600,
                    "price_range": "Â¥4000 - Â¥5200"
                }
            },
            "aihuishou": {
                "success": True,
                "product_count": 10,
                "price_stats": {
                    "min_price": 3800,
                    "max_price": 4500,
                    "average_price": 4150,
                    "price_range": "Â¥3800 - Â¥4500"
                }
            }
        },
        "keywords": {
            "keywords": ["iPhone 13", "è‹¹æœ", "128GB"],
            "search_intent": "å¯»æ‰¾åŒæ¬¾æ‰‹æœºçš„äºŒæ‰‹å¸‚åœºä»·æ ¼å’Œå›æ”¶ä»·å€¼",
            "platform_suggestions": {
                "xianyu": ["iPhone 13", "95æ–°", "ä¸ªäººè½¬è®©"],
                "aihuishou": ["iPhone 13", "è‹¹æœ", "æ‰‹æœºå›æ”¶"]
            }
        }
    },
    "function_call_result": {
        "success": True,
        "source": "function_calling",
        "keywords": [...],
        "search_intent": "..."
    }
}
```

## æ ¸å¿ƒæ–¹æ³•

### `search_from_analysis(analysis_result, **options)`

åŸºäºåˆ†æç»“æœæœç´¢ç›¸å…³äºŒæ‰‹å•†å“çš„æ ¸å¿ƒæ–¹æ³•ã€‚

**å‚æ•°ï¼š**
- `analysis_result`: ç‰©å“åˆ†æç»“æœå­—å…¸
- `max_results_per_platform`: æ¯ä¸ªå¹³å°æœ€å¤§è¿”å›ç»“æœæ•°ï¼ˆé»˜è®¤10ä¸ªï¼‰
- `include_xianyu`: æ˜¯å¦åŒ…å«é—²é±¼æœç´¢ï¼ˆé»˜è®¤Trueï¼‰
- `include_aihuishou`: æ˜¯å¦åŒ…å«çˆ±å›æ”¶æœç´¢ï¼ˆé»˜è®¤Trueï¼‰

**è¿”å›ï¼š**
åŒ…å«æœç´¢ç»“æœã€å…³é”®è¯ã€ä»·æ ¼ç»Ÿè®¡ç­‰ä¿¡æ¯çš„å­—å…¸

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from app.agents.secondhand_search.agent import SecondhandSearchAgent

# å‡†å¤‡åˆ†æç»“æœ
analysis_result = {
    "category": "ç”µå­äº§å“",
    "sub_category": "æ‰‹æœº",
    "brand": "åä¸º",
    "model": "P50 Pro",
    "condition": "9æˆæ–°",
    "description": "åä¸ºP50 Pro 256GB é»‘è‰²ï¼ŒåŠŸèƒ½æ­£å¸¸",
    "storage": "256GB",
    "color": "é»‘è‰²"
}

# æœç´¢ç›¸å…³äºŒæ‰‹å•†å“
async with SecondhandSearchAgent() as agent:
    result = await agent.search_from_analysis(
        analysis_result=analysis_result,
        max_results_per_platform=15
    )
    
    if result["success"]:
        search_result = result["result"]
        print(f"æå–çš„å…³é”®è¯: {search_result['keywords']['keywords']}")
        print(f"æœç´¢æ„å›¾: {search_result['keywords']['search_intent']}")
        print(f"æ‰¾åˆ° {search_result['total_products']} ä¸ªå•†å“")
        
        # æ˜¾ç¤ºå¹³å°ç»Ÿè®¡
        for platform, stats in search_result["platform_stats"].items():
            if stats["success"]:
                print(f"{platform}: {stats['product_count']}ä¸ªå•†å“, "
                      f"ä»·æ ¼åŒºé—´: {stats['price_stats']['price_range']}")
```

### æŒ‡å®šå¹³å°æœç´¢

```python
async def search_specific_platforms(analysis_result):
    """ä»…æœç´¢ç‰¹å®šå¹³å°"""
    async with SecondhandSearchAgent() as agent:
        # ä»…æœç´¢é—²é±¼
        xianyu_result = await agent.search_from_analysis(
            analysis_result=analysis_result,
            include_xianyu=True,
            include_aihuishou=False
        )
        
        # ä»…æœç´¢çˆ±å›æ”¶
        aihuishou_result = await agent.search_from_analysis(
            analysis_result=analysis_result,
            include_xianyu=False,
            include_aihuishou=True
        )
        
        return xianyu_result, aihuishou_result
```

### æ‰¹é‡æœç´¢

```python
async def batch_search(analysis_list):
    """æ‰¹é‡æœç´¢å¤šä¸ªç‰©å“"""
    async with SecondhandSearchAgent() as agent:
        results = []
        for analysis in analysis_list:
            result = await agent.search_from_analysis(analysis)
            results.append(result)
        return results
```

## Function Callingæœºåˆ¶

### ç³»ç»ŸPrompt
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„äºŒæ‰‹ç‰©å“äº¤æ˜“åŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©ç”¨æˆ·åœ¨äºŒæ‰‹å¹³å°ï¼ˆé—²é±¼ã€çˆ±å›æ”¶ï¼‰ä¸Šæ‰¾åˆ°ç›¸å…³å•†å“ä¿¡æ¯ã€‚

å…³é”®è¯æå–åŸåˆ™ï¼š
- å“ç‰Œå‹å·ï¼šå¦‚"iPhone 13"ã€"å°ç±³æ‰‹æœº"ã€"åä¸ºç¬”è®°æœ¬"ç­‰
- ç‰©å“ç±»å‹ï¼šå¦‚"æ‰‹æœº"ã€"ç”µè„‘"ã€"è¡£æœ"ã€"åŒ…åŒ…"ç­‰
- ç‰©å“çŠ¶æ€ï¼šå¦‚"95æ–°"ã€"9æˆæ–°"ã€"å…¨æ–°"ç­‰ï¼ˆé€‚ç”¨äºé—²é±¼ï¼‰
- åŠŸèƒ½ç‰¹å¾ï¼šå¦‚"32GB"ã€"256G"ã€"æ— çº¿å……ç”µ"ç­‰
- æè´¨é¢œè‰²ï¼šå¦‚"é»‘è‰²"ã€"ç™½è‰²"ã€"çœŸçš®"ç­‰

å¹³å°ç‰¹æ€§ï¼š
- é—²é±¼ï¼šä¸ªäººé—²ç½®äº¤æ˜“ï¼Œå…³æ³¨å“ç‰Œã€æˆè‰²ã€å‹å·
- çˆ±å›æ”¶ï¼šä¸“ä¸šå›æ”¶ä¼°ä»·ï¼Œå…³æ³¨å“ç‰Œã€å‹å·ã€å›æ”¶ä»·å€¼
```

### Functionå®šä¹‰
```json
{
    "name": "extract_secondhand_keywords",
    "description": "æ ¹æ®ç‰©å“åˆ†æç»“æœæå–ç”¨äºäºŒæ‰‹å¹³å°æœç´¢çš„å…³é”®è¯",
    "parameters": {
        "type": "object",
        "properties": {
            "keywords": {
                "type": "array",
                "items": {"type": "string"},
                "description": "3-5ä¸ªé€šç”¨å…³é”®è¯"
            },
            "search_intent": {
                "type": "string",
                "description": "æœç´¢æ„å›¾è¯´æ˜"
            },
            "platform_suggestions": {
                "type": "object",
                "properties": {
                    "xianyu": {
                        "type": "array",
                        "description": "é—²é±¼å¹³å°ç‰¹å®šå…³é”®è¯"
                    },
                    "aihuishou": {
                        "type": "array", 
                        "description": "çˆ±å›æ”¶å¹³å°ç‰¹å®šå…³é”®è¯"
                    }
                }
            }
        },
        "required": ["keywords", "search_intent", "platform_suggestions"]
    }
}
```

## å¤‡ç”¨æœºåˆ¶

### åˆ†ç±»å…³é”®è¯æ˜ å°„
- **ç”µå­äº§å“**: 
  - åŸºç¡€: ["æ•°ç ", "ç”µå­äº§å“"]
  - é—²é±¼: ["é—²ç½®æ•°ç ", "ä¸ªäººé—²ç½®"]
  - çˆ±å›æ”¶: ["æ•°ç å›æ”¶", "ç”µå­è®¾å¤‡å›æ”¶"]

- **æ‰‹æœº**:
  - åŸºç¡€: ["æ‰‹æœº", "æ™ºèƒ½æ‰‹æœº"] 
  - é—²é±¼: ["äºŒæ‰‹æ‰‹æœº", "é—²ç½®æ‰‹æœº", "ä¸ªäººè½¬è®©"]
  - çˆ±å›æ”¶: ["æ‰‹æœºå›æ”¶", "æ—§æ‰‹æœº", "æ‰‹æœºä¼°ä»·"]

### å“ç‰Œå…³é”®è¯æ˜ å°„
- **è‹¹æœ**: ["Apple", "è‹¹æœ", "iPhone", "iPad", "MacBook"]
- **åä¸º**: ["åä¸º", "Huawei", "Honor", "è£è€€"]
- **å°ç±³**: ["å°ç±³", "Xiaomi", "Redmi", "çº¢ç±³"]

### çŠ¶æ€æè¿°æ˜ å°„ï¼ˆé—²é±¼ä¸“ç”¨ï¼‰
- **å…¨æ–°**: ["å…¨æ–°", "æœªæ‹†å°", "æ­£å“å…¨æ–°"]
- **95æ–°**: ["95æ–°", "ææ–°", "è½»å¾®ä½¿ç”¨"]
- **9æˆæ–°**: ["9æˆæ–°", "æˆè‰²å¾ˆå¥½"]

## é…ç½®è¦æ±‚

### ç¯å¢ƒå˜é‡
```bash
# è“å¿ƒå¤§æ¨¡å‹é…ç½®
LANXIN_APP_ID=your_app_id
LANXIN_APP_KEY=your_app_key
LANXIN_API_BASE_URL=https://api.xxx.com/v1/chat/completions
LANXIN_TEXT_MODEL=your_text_model
```

## ä¾èµ–æ¨¡å—

- **æç¤ºè¯æ¨¡å—**: `app.prompts.secondhand_search_prompts`
- **é—²é±¼æœç´¢æœåŠ¡**: `app.services.xianyu_service`
- **çˆ±å›æ”¶æœç´¢æœåŠ¡**: `app.services.aihuishou_service`
- **æ•°æ®æ¨¡å‹**: `app.models.secondhand_search_models`
- **è®¤è¯å·¥å…·**: `app.utils.vivo_auth`
- **é…ç½®ç®¡ç†**: `app.core.config`
- **æ—¥å¿—ç³»ç»Ÿ**: `app.core.logger`

## æ€§èƒ½ç‰¹ç‚¹

### å“åº”é€Ÿåº¦
- **å…³é”®è¯æå–**: é€šå¸¸åœ¨2-3ç§’å†…å®Œæˆ
- **å¹³å°æœç´¢**: 2-4ç§’è·å–ç»“æœï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
- **æ€»è€—æ—¶**: çº¦4-7ç§’å®Œæˆå®Œæ•´æœç´¢

### å‡†ç¡®ç‡
- **Function CallingæˆåŠŸç‡**: 85%+ (æ™ºèƒ½æå–)
- **å¤‡ç”¨æœºåˆ¶è¦†ç›–ç‡**: 100% (ä¿åº•æœåŠ¡)
- **æœç´¢ç›¸å…³æ€§**: åŸºäºä¸“ä¸šæç¤ºè¯ä¼˜åŒ–

### å¹¶å‘æ”¯æŒ
- **å¼‚æ­¥è®¾è®¡**: æ”¯æŒé«˜å¹¶å‘è¯·æ±‚
- **å¹¶è¡Œæœç´¢**: å¤šå¹³å°åŒæ—¶æœç´¢
- **èµ„æºç®¡ç†**: è‡ªåŠ¨ç®¡ç†HTTPè¿æ¥
- **é”™è¯¯æ¢å¤**: æ™ºèƒ½çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

## å¹³å°ç‰¹è‰²

### é—²é±¼å¹³å°ç‰¹ç‚¹
- **ä¸ªäººäº¤æ˜“**: C2Cæ¨¡å¼ï¼Œä»·æ ¼æ›´çµæ´»
- **æˆè‰²é‡è¦**: å•†å“çŠ¶æ€å¯¹ä»·æ ¼å½±å“å¤§
- **åœ°åŸŸå› ç´ **: åŒåŸäº¤æ˜“æ›´å—æ¬¢è¿
- **è®®ä»·ç©ºé—´**: é€šå¸¸å¯ä»¥è®®ä»·

### çˆ±å›æ”¶å¹³å°ç‰¹ç‚¹
- **ä¸“ä¸šå›æ”¶**: B2Cæ¨¡å¼ï¼Œä»·æ ¼ç›¸å¯¹æ ‡å‡†
- **å³æ—¶ä¼°ä»·**: æä¾›æ ‡å‡†åŒ–å›æ”¶ä»·æ ¼
- **å…¨å›½æœåŠ¡**: è¦†ç›–å…¨å›½å¤§éƒ¨åˆ†åœ°åŒº
- **å“ç±»é™åˆ¶**: ä¸»è¦å›æ”¶ç”µå­äº§å“ã€å¥¢ä¾ˆå“

## ä¸å…¶ä»–æ¨¡å—åä½œ

### ä¸Šæ¸¸ä¾èµ–
- **å›¾ç‰‡åˆ†ææœåŠ¡**: æä¾›ç‰©å“è¯†åˆ«ç»“æœ
- **æ–‡å­—åˆ†ææœåŠ¡**: æä¾›æ–‡æœ¬è§£æç»“æœ
- **åˆ›æ„åè°ƒå™¨**: è·å–ç»¼åˆåˆ†æç»“æœ

### ä¸‹æ¸¸è¾“å‡º
- **å¤„ç½®æ¨èAgent**: å‚è€ƒå¸‚åœºä»·æ ¼åˆ¶å®šå¤„ç½®ç­–ç•¥
- **åˆ›æ„æ”¹é€ Agent**: ç»“åˆå¸‚åœºä»·å€¼è¯„ä¼°æ”¹é€ ä»·å€¼
- **å‰ç«¯å±•ç¤º**: ç›´æ¥å±•ç¤ºå•†å“æœç´¢ç»“æœå’Œä»·æ ¼åˆ†æ

## é”™è¯¯å¤„ç†

### è¾“å…¥éªŒè¯
- æ£€æŸ¥åˆ†æç»“æœæ ¼å¼å’Œå¿…éœ€å­—æ®µ
- éªŒè¯å‚æ•°èŒƒå›´å’Œç±»å‹
- å¤„ç†ç©ºå€¼å’Œå¼‚å¸¸æ•°æ®

### APIå®¹é”™
- Function Callingå¤±è´¥è‡ªåŠ¨é™çº§
- å¹³å°æœç´¢APIå¼‚å¸¸å¤„ç†
- ç½‘ç»œé”™è¯¯é‡è¯•æœºåˆ¶

### ç»“æœå¤„ç†
- æœç´¢ç»“æœæ ¼å¼éªŒè¯
- ä»·æ ¼æ•°æ®æ¸…æ´—å’Œæ ¡éªŒ
- ç»Ÿè®¡ä¿¡æ¯è®¡ç®—å®¹é”™

## æ—¥å¿—è®°å½•

### æ“ä½œæ—¥å¿—
- è¯¦ç»†çš„æœç´¢æµç¨‹è®°å½•
- å…³é”®è¯æå–è¿‡ç¨‹è¿½è¸ª
- å¹³å°æœç´¢ç»“æœç»Ÿè®¡

### æ€§èƒ½ç›‘æ§
- APIè°ƒç”¨è€—æ—¶ç»Ÿè®¡
- æœç´¢æˆåŠŸç‡ç›‘æ§
- é”™è¯¯é¢‘ç‡åˆ†æ

### ä¸šåŠ¡æŒ‡æ ‡
- ç”¨æˆ·æœç´¢è¡Œä¸ºåˆ†æ
- çƒ­é—¨å•†å“ç±»åˆ«ç»Ÿè®¡
- ä»·æ ¼è¶‹åŠ¿æ•°æ®æ”¶é›† 