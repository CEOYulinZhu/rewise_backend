# é—²ç½®ç‰©è¯­åç«¯ç³»ç»Ÿ

åŸºäºFastAPI + Celery + PostgreSQL + Redis + LangChainçš„æ™ºèƒ½ç‰©å“å¤„ç½®å»ºè®®ç³»ç»Ÿã€‚

## ğŸ¯ é¡¹ç›®ç®€ä»‹

é—²ç½®ç‰©è¯­æ˜¯ä¸€ä¸ªåŸºäºäººå·¥æ™ºèƒ½çš„ç‰©å“å¤„ç½®å»ºè®®ç³»ç»Ÿï¼Œèƒ½å¤Ÿé€šè¿‡å›¾ç‰‡è¯†åˆ«æˆ–æ–‡å­—æè¿°åˆ†æç”¨æˆ·çš„é—²ç½®ç‰©å“ï¼Œå¹¶æä¾›ä¸ªæ€§åŒ–çš„å¤„ç½®å»ºè®®ï¼ŒåŒ…æ‹¬åˆ›æ„æ”¹é€ ã€å›æ”¶æèµ ã€äºŒæ‰‹äº¤æ˜“ç­‰å¤šç§æ–¹æ¡ˆã€‚

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **Webæ¡†æ¶**: FastAPI (é«˜æ€§èƒ½å¼‚æ­¥APIæ¡†æ¶)
- **ä¾èµ–æ³¨å…¥**: FastAPI Depends (æ¨¡å—åŒ–çš„ä¾èµ–ç®¡ç†)
- **ä»»åŠ¡é˜Ÿåˆ—**: Celery + Redis (å¤„ç†è€—æ—¶çš„AIåˆ†æä»»åŠ¡)
- **æ•°æ®åº“**: PostgreSQL + SQLAlchemy (å…³ç³»å‹æ•°æ®å­˜å‚¨)
- **å‘é‡æ•°æ®åº“**: ChromaDB (çŸ¥è¯†åº“æ£€ç´¢)
- **AIæœåŠ¡**: è“å¿ƒå¤§æ¨¡å‹ (å›¾åƒè¯†åˆ«å’Œæ–‡æœ¬åˆ†æ)
- **çˆ¬è™«**: httpx (å¸‚åœºæ•°æ®é‡‡é›†)

### ç³»ç»Ÿæ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨       â”‚â”€â”€â”€â–¶â”‚   FastAPI       â”‚â”€â”€â”€â–¶â”‚   AI Agent      â”‚
â”‚                â”‚    â”‚   WebæœåŠ¡       â”‚    â”‚   å¤„ç†å±‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚                        â”‚
                               â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚   Redis         â”‚    â”‚   è“å¿ƒå¤§æ¨¡å‹     â”‚
â”‚   ä¸»æ•°æ®åº“       â”‚    â”‚   ç¼“å­˜+é˜Ÿåˆ—      â”‚    â”‚   AIæœåŠ¡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚                        â”‚
                               â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ChromaDB      â”‚    â”‚   Celery        â”‚    â”‚   å¸‚åœºçˆ¬è™«       â”‚
â”‚   çŸ¥è¯†å‘é‡åº“     â”‚    â”‚   å¼‚æ­¥ä»»åŠ¡       â”‚    â”‚   æ•°æ®é‡‡é›†       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
é—²ç½®ç‰©è¯­-åç«¯/
â”œâ”€â”€ app/                        # ä¸»åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ agents/                 # AI Agentæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ processing_agent.py # ä¸»å¤„ç†Agent
â”‚   â”œâ”€â”€ api/                    # APIæ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ dependencies/       # ä¾èµ–æ³¨å…¥æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py         # è®¤è¯ç›¸å…³ä¾èµ–
â”‚   â”‚   â”‚   â”œâ”€â”€ database.py     # æ•°æ®åº“ç›¸å…³ä¾èµ–
â”‚   â”‚   â”‚   â””â”€â”€ validation.py   # éªŒè¯ç›¸å…³ä¾èµ–
â”‚   â”‚   â””â”€â”€ v1/                 # V1ç‰ˆæœ¬API
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ tasks.py        # ä»»åŠ¡ç›¸å…³æ¥å£
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py           # åº”ç”¨é…ç½®
â”‚   â”‚   â””â”€â”€ logger.py           # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ database/               # æ•°æ®åº“å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ connection.py       # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ task.py             # ä»»åŠ¡æ¨¡å‹
â”‚   â”œâ”€â”€ services/               # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ task_service.py     # ä»»åŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ crawler/            # çˆ¬è™«æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ market_crawler.py
â”‚   â”‚   â”œâ”€â”€ llm/                # LLMæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ lanxin_service.py
â”‚   â”‚   â””â”€â”€ rag/                # RAGæœåŠ¡
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ knowledge_service.py
â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”œâ”€â”€ alembic/                    # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ versions/
â”‚   â””â”€â”€ env.py
â”œâ”€â”€ data/                       # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ chroma_db/              # ChromaDBæ•°æ®
â”‚   â””â”€â”€ uploads/                # ä¸Šä¼ æ–‡ä»¶
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”œâ”€â”€ logs/                       # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ scripts/                    # è„šæœ¬æ–‡ä»¶
â”‚   â””â”€â”€ start_dev.py            # å¼€å‘å¯åŠ¨è„šæœ¬
â”œâ”€â”€ tests/                      # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ services/
â”‚   â””â”€â”€ agents/
â”œâ”€â”€ main.py                     # FastAPIåº”ç”¨å…¥å£
â”œâ”€â”€ celery_app.py              # Celeryåº”ç”¨é…ç½®
â”œâ”€â”€ requirements.txt           # Pythonä¾èµ–
â”œâ”€â”€ alembic.ini               # Alembicé…ç½®
â”œâ”€â”€ env.example               # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â””â”€â”€ README.md                 # é¡¹ç›®è¯´æ˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python 3.9+
- PostgreSQL 13+
- Redis 6+

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd é—²ç½®ç‰©è¯­-åç«¯
```

2. **å®‰è£…ä¾èµ–**
```bash
pip install -r requirements.txt
```

3. **é…ç½®ç¯å¢ƒå˜é‡**
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
cp env.example .env

# ç¼–è¾‘.envæ–‡ä»¶ï¼Œè®¾ç½®å¿…è¦çš„é…ç½®é¡¹
```

4. **åˆå§‹åŒ–æ•°æ®åº“**
```bash
# åˆ›å»ºæ•°æ®åº“è¿ç§»
alembic revision --autogenerate -m "Initial migration"

# æ‰§è¡Œè¿ç§»
alembic upgrade head
```

5. **å¯åŠ¨æœåŠ¡**
```bash
# å¼€å‘ç¯å¢ƒä¸€é”®å¯åŠ¨
python scripts/start_dev.py

# æˆ–è€…æ‰‹åŠ¨å¯åŠ¨
python main.py
```

6. **å¯åŠ¨Celery Worker** (å¦å¼€ç»ˆç«¯)
```bash
celery -A celery_app worker --loglevel=info
```

## ğŸ“š APIæ–‡æ¡£

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ä»¥ä¸‹URLæŸ¥çœ‹APIæ–‡æ¡£ï¼š
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

### ä¸»è¦æ¥å£

#### åˆ›å»ºå¤„ç†ä»»åŠ¡
```http
POST /api/v1/tasks
Content-Type: application/json

{
    "image_url": "https://example.com/image.jpg",
    "text_description": "ä¸€ä»¶æ—§ç¾Šæ¯›è¡«ï¼Œè¢–å£æœ‰äº›ç£¨æŸ",
    "user_location": {"lat": 39.9042, "lon": 116.4074}
}
```

#### æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
```http
GET /api/v1/tasks/{task_id}
```

### ä¾èµ–æ³¨å…¥ä½¿ç”¨ç¤ºä¾‹

åœ¨APIè·¯ç”±ä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼š

```python
from fastapi import Depends
from app.api.dependencies.database import get_database
from app.api.dependencies.validation import validate_task_input

@router.post("/tasks")
async def create_task(
    task_data: TaskCreate,
    db: AsyncSession = Depends(get_database),           # æ•°æ®åº“ä¾èµ–
    validated_input: dict = Depends(validate_task_input) # éªŒè¯ä¾èµ–
):
    # è·¯ç”±å¤„ç†é€»è¾‘
    pass
```

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/api/test_tasks.py

# è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
pytest --cov=app tests/
```

## ğŸ³ Dockeréƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t xianzhiwuyu-backend .

# ä½¿ç”¨docker-composeå¯åŠ¨
docker-compose up -d
```

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„APIæ¥å£
1. åœ¨`app/api/v1/`ä¸‹åˆ›å»ºæ–°çš„è·¯ç”±æ–‡ä»¶
2. åœ¨`main.py`ä¸­æ³¨å†Œè·¯ç”±
3. æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹

### æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹
1. åœ¨`app/models/`ä¸‹å®šä¹‰SQLAlchemyæ¨¡å‹
2. åˆ›å»ºæ•°æ®åº“è¿ç§»ï¼š`alembic revision --autogenerate -m "æè¿°"`
3. æ‰§è¡Œè¿ç§»ï¼š`alembic upgrade head`

### æ·»åŠ æ–°çš„æœåŠ¡
1. åœ¨`app/services/`ä¸‹åˆ›å»ºæœåŠ¡ç±»
2. åœ¨Agentä¸­é›†æˆæ–°æœåŠ¡
3. æ·»åŠ ç›¸åº”çš„é…ç½®é¡¹

### æ·»åŠ æ–°çš„ä¾èµ–é¡¹
1. åœ¨`app/api/dependencies/`ä¸‹åˆ›å»ºæˆ–ç¼–è¾‘ç›¸åº”çš„ä¾èµ–æ–‡ä»¶ï¼š
   - `auth.py`: è®¤è¯å’Œæƒé™ç›¸å…³ä¾èµ–
   - `database.py`: æ•°æ®åº“ç›¸å…³ä¾èµ–
   - `validation.py`: è¾“å…¥éªŒè¯ç›¸å…³ä¾èµ–
2. åœ¨`app/api/dependencies/__init__.py`ä¸­å¯¼å‡ºæ–°çš„ä¾èµ–é¡¹
3. åœ¨APIè·¯ç”±ä¸­ä½¿ç”¨`Depends()`æ³¨å…¥ä¾èµ–é¡¹

## ğŸ›ï¸ ä¾èµ–æ³¨å…¥æ¶æ„

é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–çš„ä¾èµ–æ³¨å…¥è®¾è®¡ï¼Œå°†ä¸åŒç±»å‹çš„ä¾èµ–é¡¹åˆ†ç¦»ç®¡ç†ï¼š

### ğŸ“‹ ä¾èµ–é¡¹åˆ†ç±»
- **`database.py`**: æ•°æ®åº“ä¼šè¯ç®¡ç†
  - `get_database()`: æä¾›å¼‚æ­¥æ•°æ®åº“ä¼šè¯
  - è‡ªåŠ¨å¤„ç†è¿æ¥çš„åˆ›å»ºå’Œå…³é—­
  
- **`auth.py`**: è®¤è¯å’Œé…ç½®ç®¡ç†  
  - `get_app_settings()`: è·å–åº”ç”¨é…ç½®
  - é¢„ç•™ç”¨æˆ·è®¤è¯å’Œæƒé™éªŒè¯åŠŸèƒ½

- **`validation.py`**: è¾“å…¥éªŒè¯
  - `validate_task_input()`: éªŒè¯ä»»åŠ¡åˆ›å»ºå‚æ•°
  - ç»Ÿä¸€çš„å‚æ•°æ ¡éªŒé€»è¾‘

### ğŸ”„ ä¾èµ–æ³¨å…¥ä¼˜åŠ¿
- **ğŸ¯ æ¨¡å—åŒ–**: ä¸åŒç±»å‹çš„ä¾èµ–é¡¹åˆ†ç¦»ç®¡ç†
- **â™»ï¸ å¯é‡ç”¨**: å¤šä¸ªè·¯ç”±å¯å…±äº«ç›¸åŒçš„ä¾èµ–é¡¹
- **ğŸ§ª æ˜“æµ‹è¯•**: ä¾èµ–é¡¹å¯è½»æ¾è¢«æ¨¡æ‹Ÿæ›¿æ¢
- **ğŸ”’ ç±»å‹å®‰å…¨**: å®Œæ•´çš„ç±»å‹æ³¨è§£æ”¯æŒ
- **âš¡ é«˜æ€§èƒ½**: FastAPIè‡ªåŠ¨ç¼“å­˜ä¾èµ–é¡¹ç»“æœ

## ğŸ”§ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®é¡¹è¯´æ˜è¯·å‚è€ƒ`env.example`æ–‡ä»¶ä¸­çš„æ³¨é‡Šã€‚

æ ¸å¿ƒé…ç½®ï¼š
- `DATABASE_URL`: PostgreSQLæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
- `REDIS_URL`: Redisè¿æ¥å­—ç¬¦ä¸²
- `LANXIN_API_KEY`: è“å¿ƒå¤§æ¨¡å‹APIå¯†é’¥
- `SECRET_KEY`: åº”ç”¨å¯†é’¥

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

- æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š`logs/app.log`
- æ—¥å¿—çº§åˆ«å¯é€šè¿‡`LOG_LEVEL`ç¯å¢ƒå˜é‡é…ç½®
- æ”¯æŒæ—¥å¿—è½®è½¬å’Œå‹ç¼©

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æ­¤é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ“ è”ç³»æˆ‘ä»¬

- é¡¹ç›®é“¾æ¥: [GitHub Repository]
- é—®é¢˜åé¦ˆ: [GitHub Issues]

---

**é—²ç½®ç‰©è¯­** - è®©æ¯ä¸€ä»¶ç‰©å“éƒ½æœ‰æœ€å¥½çš„å½’å®¿ â™»ï¸ 